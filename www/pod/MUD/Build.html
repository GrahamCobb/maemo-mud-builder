<head>
<!-- Generated by perlmod2www.pl -->
<title>
Build documentation.
</title>
<link rel="stylesheet" type="text/css" href="../perl.css">
</head>
<body bgcolor="white">
<span id="modRootPath">MUD</span>
<span id="modName">Build</span>
<div id="sep"></div>
<a name="TOP" id="TOP"></a>
<table id="daArea" width="100%"><tr><td id="daEntry" ><a href="#SUMMARY">Summary</a></td><td id="daEntry" ><a href="#libs">Included libraries</a></td><td id="daEntry" ><a href="#vardefs">Package variables</a></td><td id="daEntry" ><a href="#SYNOPSIS">Synopsis</a></td><td id="daEntry" ><a href="#DESCRIPTION">Description</a></td><td id="daEntry" ><a href="#General">General documentation</a></td><td id="daEntry" ><a href="#Methods">Methods</a></td></tr></table>
<div id="sep"></div>
<div id="descTitle">Summary</div>
<div id="descArea"><B>MUD::Build</B> - Build packages suitable for upload</div>
<div id="sep"></div>
<a name="vardefs" id="vardefs"></a><div id="descTitle">Package variables</div>
<div id="descArea"><div id="libEntry">No package variables defined.</div>
</div>
<div id="sep"></div>
<div id="descTitle">Included modules</div>
<div id="descArea"><div id="libEntry"><span id="use">Carp</span></div>
<div id="libEntry"><span id="use">Data::Dumper</span> </div>
<div id="libEntry"><span id="use">File::Basename</span> </div>
<div id="libEntry"><span id="use">File::Path</span> </div>
<div id="libEntry"><span id="use">File::Spec</span> </div>
<div id="libEntry"><span id="use"><a href="Config.html">MUD::Config</a></span> </div>
<div id="libEntry"><span id="use"><a href="Package.html">MUD::Package</a></span> </div>
</div>
<div id="sep"></div>
<a name="libs" id="libs"></a>
<div id="descTitle">Inherit</div>
<div id="descArea"><div id="error">Unavailable</div></div>
<div id="sep"></div>
<a name="SYNOPSIS" id="SYNOPSIS"></a>
<div id="descTitle">Synopsis</div>
<div id="descArea"><pre id="podParagraph">    use MUD::Build;
    my $mud = <B>MUD::Build</B>->new( package => 'vim' );
    $mud->build();</pre>
</div>
<div id="sep"></div>
<a name="DESCRIPTION" id="DESCRIPTION"></a>
<div id="descTitle">Description</div>
<div id="descArea">This class is primarily responsible for controlling the build process<br />used by mud.
</div>
<div id="sep"></div>
<a name="Methods" id="Methods"></a>
<div id="descTitle">Methods</div>
<table id="methIndArea" width="100%" cellspacing="0"><tr><td id="methIndEntry">_init</td><td id="methIndEntry"><a href="#POD1">Description</a></td><td id="methIndEntry"><a href="#CODE1">Code</a></td></tr>
<tr><td id="methIndEntry">addDebs</td><td id="methIndEntry"><div id="error">No description</div></td><td id="methIndEntry"><a href="#CODE2">Code</a></td></tr>
<tr><td id="methIndEntry">build</td><td id="methIndEntry"><a href="#POD2">Description</a></td><td id="methIndEntry"><a href="#CODE3">Code</a></td></tr>
<tr><td id="methIndEntry">clean</td><td id="methIndEntry"><a href="#POD3">Description</a></td><td id="methIndEntry"><a href="#CODE4">Code</a></td></tr>
<tr><td id="methIndEntry">compile</td><td id="methIndEntry"><a href="#POD4">Description</a></td><td id="methIndEntry"><a href="#CODE5">Code</a></td></tr>
<tr><td id="methIndEntry">copy</td><td id="methIndEntry"><a href="#POD5">Description</a></td><td id="methIndEntry"><a href="#CODE6">Code</a></td></tr>
<tr><td id="methIndEntry">fetch</td><td id="methIndEntry"><a href="#POD6">Description</a></td><td id="methIndEntry"><a href="#CODE7">Code</a></td></tr>
<tr><td id="methIndEntry">genDebControl</td><td id="methIndEntry"><div id="error">No description</div></td><td id="methIndEntry"><a href="#CODE8">Code</a></td></tr>
<tr><td id="methIndEntry">new</td><td id="methIndEntry"><a href="#POD7">Description</a></td><td id="methIndEntry"><a href="#CODE9">Code</a></td></tr>
<tr><td id="methIndEntry">patch</td><td id="methIndEntry"><a href="#POD8">Description</a></td><td id="methIndEntry"><a href="#CODE10">Code</a></td></tr>
<tr><td id="methIndEntry">patchDebControl</td><td id="methIndEntry"><div id="error">No description</div></td><td id="methIndEntry"><a href="#CODE11">Code</a></td></tr>
<tr><td id="methIndEntry">readDebControl</td><td id="methIndEntry"><div id="error">No description</div></td><td id="methIndEntry"><a href="#CODE12">Code</a></td></tr>
<tr><td id="methIndEntry">source</td><td id="methIndEntry"><a href="#POD9">Description</a></td><td id="methIndEntry"><a href="#CODE13">Code</a></td></tr>
<tr><td id="methIndEntry">writeDebControl</td><td id="methIndEntry"><div id="error">No description</div></td><td id="methIndEntry"><a href="#CODE14">Code</a></td></tr>
</table>
<div id="sep"></div>
<a name="MethDesc" id="MethDesc"></a>
<div id="mainTitle">Methods description</div>
<div id="sep"></div>
<table id="methDescTitle" width="100%"><tr><td WIDTH="200"><a name="_pod__init" id="_pod__init"></a><a name="POD1" id="POD1"></a>_init</td><td ><a href="#CODE1">code</a></td><td >&nbsp;&nbsp;&nbsp;&nbsp;</td><td ><a href="#POD2">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<table id="methDescArea" width="100%"><tr><td>Initialise a new instance. Private method.</td></tr></table>
<div id="sep"></div>
<table id="methDescTitle" width="100%"><tr><td WIDTH="200"><a name="_pod_build" id="_pod_build"></a><a name="POD2" id="POD2"></a>build</td><td ><a href="#CODE3">code</a></td><td ><a href="#POD1">prev</a></td><td ><a href="#POD3">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<table id="methDescArea" width="100%"><tr><td>Build the configured package and place the deb files ready for upload<br />in the uploads/ directory.</td></tr></table>
<div id="sep"></div>
<table id="methDescTitle" width="100%"><tr><td WIDTH="200"><a name="_pod_clean" id="_pod_clean"></a><a name="POD3" id="POD3"></a>clean</td><td ><a href="#CODE4">code</a></td><td ><a href="#POD2">prev</a></td><td ><a href="#POD4">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<table id="methDescArea" width="100%"><tr><td>Remove the build directory and any temporary files used therein.</td></tr></table>
<div id="sep"></div>
<table id="methDescTitle" width="100%"><tr><td WIDTH="200"><a name="_pod_compile" id="_pod_compile"></a><a name="POD4" id="POD4"></a>compile</td><td ><a href="#CODE5">code</a></td><td ><a href="#POD3">prev</a></td><td ><a href="#POD5">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<table id="methDescArea" width="100%"><tr><td>Build the unpacked, and potentially patched, binaries.</td></tr></table>
<div id="sep"></div>
<table id="methDescTitle" width="100%"><tr><td WIDTH="200"><a name="_pod_copy" id="_pod_copy"></a><a name="POD5" id="POD5"></a>copy</td><td ><a href="#CODE6">code</a></td><td ><a href="#POD4">prev</a></td><td ><a href="#POD6">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<table id="methDescArea" width="100%"><tr><td>Copy output files - including debs, tarballs, dsc and changes files - to<br />the upload directory.</td></tr></table>
<div id="sep"></div>
<table id="methDescTitle" width="100%"><tr><td WIDTH="200"><a name="_pod_fetch" id="_pod_fetch"></a><a name="POD6" id="POD6"></a>fetch</td><td ><a href="#CODE7">code</a></td><td ><a href="#POD5">prev</a></td><td ><a href="#POD7">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<table id="methDescArea" width="100%"><tr><td>Download the source for the package and unpack it in the build directory.</td></tr></table>
<div id="sep"></div>
<table id="methDescTitle" width="100%"><tr><td WIDTH="200"><a name="_pod_new( OPTS )" id="_pod_new( OPTS )"></a><a name="POD7" id="POD7"></a>new( OPTS )</td><td ><a href="#CODE9">code</a></td><td ><a href="#POD6">prev</a></td><td ><a href="#POD8">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<table id="methDescArea" width="100%"><tr><td>Create a new instance. OPTS is a hash containing name/value pairs:<br /><div id="podItem">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;package</div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Name of the package. This is required.  This can either a <br /><a href="Package.html" target="urlWin" id="podUrl"><b>MUD::Package</b></a> <i>reference</i>, or the name of a package. The use of<br />reference passing is used when doing recursive, dependency builds.<br /></td></tr></table>
<div id="sep"></div>
<table id="methDescTitle" width="100%"><tr><td WIDTH="200"><a name="_pod_patch" id="_pod_patch"></a><a name="POD8" id="POD8"></a>patch</td><td ><a href="#CODE10">code</a></td><td ><a href="#POD7">prev</a></td><td ><a href="#POD9">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<table id="methDescArea" width="100%"><tr><td>Apply any patches for the given package and modify Debian control structures<br />to apply to the Maemo SDK.</td></tr></table>
<div id="sep"></div>
<table id="methDescTitle" width="100%"><tr><td WIDTH="200"><a name="_pod_source" id="_pod_source"></a><a name="POD9" id="POD9"></a>source</td><td ><a href="#CODE13">code</a></td><td ><a href="#POD8">prev</a></td><td ><a href="#POD10">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<table id="methDescArea" width="100%"><tr><td>Build the unpacked, and potentially patched, source packages ready<br />for upload to the autobuilder.<br />At the moment, no check is made that a compile step is done previously,<br />however this is seriously recommended to ensure that the auto-calculation<br />of Build-Depends is done correctly.</td></tr></table>
<div id="sep"></div>
<a name="MethCode" id="MethCode"></a>
<div id="mainTitle">Methods code</div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE1" id="CODE1"></a>_init</td><td ><a href="#POD1">description</a></td><td >prev</td><td ><a href="#CODE2">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="privSubName">_init</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;

    <span id="var">$self</span>-&gt;<span id="braces">{</span>config<span id="braces">}</span> ||= <span id="perlKey">new</span> <span id="module">MUD</span>::<span id="method">Config</span><span id="braces">(</span><span id="braces">)</span>;
    <span id="perlKey">my</span> <span id="var">$name</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span> or <span id="method">croak</span><span id="braces">(</span><span id="dqStr">"Package not specified."</span><span id="braces">)</span>;
    <span id="perlKey">if</span> <span id="braces">(</span><span id="perlFunc">ref</span><span id="braces">(</span><span id="var">$name</span><span id="braces">)</span><span id="braces">)</span> <span id="braces">{</span>
        <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span> = <span id="var">$name</span>;
        <span id="var">$name</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span> = <span id="var">$name</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span>;
    <span id="braces">}</span> <span id="perlKey">else</span> <span id="braces">{</span>
        <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span> = <span id="perlKey">new</span> <span id="module">MUD</span>::<span id="method">Package</span><span id="braces">(</span>config =&gt; <span id="var">$self</span>-&gt;<span id="braces">{</span>config<span id="braces">}</span><span id="braces">)</span>;
        <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="method">load</span><span id="braces">(</span><span id="var">$name</span><span id="braces">)</span>;
    <span id="braces">}</span>
    <span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>config<span id="braces">}</span>-&gt;<span id="method">directory</span><span id="braces">(</span><span id="sqStr">'BUILD_DIR'</span><span id="braces">)</span>.<span id="dqStr">"/<span id="var">$name</span>"</span>;

    <span id="perlKey">my</span> <span id="var">$buildDir</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span>.<span id="sqStr">'/.build'</span>;
    <span id="var">$buildDir</span> = <span id="perlFunc">readlink</span><span id="braces">(</span><span id="var">$buildDir</span><span id="braces">)</span> <span id="perlKey">if</span> -l <span id="var">$buildDir</span>;
    <span id="perlFunc">print</span> <span id="dqStr">"Build dir = [<span id="var">$buildDir</span>]\n"</span>;
    <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span> = <span id="var">$buildDir</span> <span id="perlKey">if</span> -d <span id="var">$buildDir</span>;

    <span id="var">$ENV</span><span id="braces">{</span><span id="sqStr">'MUD_PACKAGES_DIR'</span><span id="braces">}</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>config<span id="braces">}</span>-&gt;<span id="method">directory</span><span id="braces">(</span><span id="sqStr">'PACKAGES_DIR'</span><span id="braces">)</span>;
    <span id="var">$ENV</span><span id="braces">{</span><span id="sqStr">'MUD_PACKAGES_RELDIR'</span><span id="braces">}</span> = <span id="module">File::Spec</span>-&gt;<span id="method">abs2rel</span><span id="braces">(</span><span id="var">$ENV</span><span id="braces">{</span><span id="sqStr">'MUD_PACKAGES_DIR'</span><span id="braces">}</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span>.<span id="sqStr">'/.build'</span><span id="braces">)</span>;</pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE2" id="CODE2"></a>addDebs</td><td >description</td><td ><a href="#CODE1">prev</a></td><td ><a href="#CODE3">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">addDebs</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;
    <span id="perlKey">my</span> <span id="braces">(</span><span id="var">$ref</span>, <span id="var">$dir</span>, <span id="var">$pattern</span><span id="braces">)</span> = <span id="var">@_</span>;

    <span id="perlFunc">print</span> <span id="dqStr">"Finding debs for [<span id="var">$pattern</span>] in [<span id="var">$dir</span>]\n"</span>;
    <span id="perlKey">my</span> <span id="var">@results</span> = `find <span id="sqStr">'$dir'</span> -type f -name <span id="sqStr">'$pattern.deb'</span> -o -name <span id="sqStr">'${pattern}_source.changes'</span> -o -name <span id="sqStr">'$pattern.dsc'</span> -o -name <span id="sqStr">'$pattern.tar.gz'</span> -o -name <span id="sqStr">'$pattern.diff.gz'</span>`;
    <span id="perlKey">my</span> <span id="var">@add</span>     = <span id="braces">(</span><span id="braces">)</span>;
    <span id="perlKey">foreach</span> <span id="perlKey">my</span> <span id="var">$d</span> <span id="braces">(</span><span id="var">@results</span><span id="braces">)</span> <span id="braces">{</span>
        <span id="perlFunc">chomp</span><span id="braces">(</span><span id="var">$d</span><span id="braces">)</span>;
        <span id="perlKey">next</span> <span id="perlKey">if</span> <span id="var">$ref</span>-&gt;<span id="braces">{</span><span id="var">$d</span><span id="braces">}</span>++ or <span id="var">$d</span> !~ <span id="regExp">/\.deb$/</span>;
        <span id="perlKey">my</span> <span id="var">@deps</span> = <span id="module"><a href="Package.html">MUD::Package</a></span>-&gt;<span id="method">parseField</span><span id="braces">(</span><span id="sqStr">'Depends'</span>, <span id="perlFunc">scalar</span><span id="braces">(</span>`dpkg --info <span id="sqStr">'$d'</span>`<span id="braces">)</span><span id="braces">)</span>;
        <span id="perlKey">foreach</span> <span id="perlKey">my</span> <span id="var">$p</span> <span id="braces">(</span><span id="var">@deps</span><span id="braces">)</span> <span id="braces">{</span>
            <span id="var">$self</span>-&gt;<span id="method">addDebs</span><span id="braces">(</span><span id="var">$ref</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>config<span id="braces">}</span>-&gt;<span id="method">directory</span><span id="braces">(</span><span id="sqStr">'BUILD_DIR'</span><span id="braces">)</span>,
                                 <span id="dqStr">"${p}_*"</span><span id="braces">)</span> <span id="perlKey">unless</span> <span id="var">$ref</span>-&gt;<span id="braces">{</span><span id="var">$p</span><span id="braces">}</span>;
        <span id="braces">}</span>
    <span id="braces">}</span></pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE3" id="CODE3"></a>build</td><td ><a href="#POD2">description</a></td><td ><a href="#CODE2">prev</a></td><td ><a href="#CODE4">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">build</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;

    <span id="comment"># Don't build more than once in the same command</span><br />    <span id="perlFunc">print</span> <span id="dqStr">"***Already built <span id="var">$self</span>-&gt;{package}***\n"</span> <span id="perlKey">if</span> %::built-&gt;<span id="braces">{</span><span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span><span id="braces">}</span>;
    <span id="perlKey">return</span> <span id="perlKey">if</span> %::built-&gt;<span id="braces">{</span><span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span><span id="braces">}</span>++;

    <span id="var">$self</span>-&gt;<span id="method">clean</span><span id="braces">(</span><span id="braces">)</span>;
    <span id="var">$self</span>-&gt;<span id="method">fetch</span><span id="braces">(</span><span id="braces">)</span>;
    <span id="var">$self</span>-&gt;<span id="method">patch</span><span id="braces">(</span><span id="braces">)</span>;
    <span id="var">$self</span>-&gt;<span id="method">compile</span><span id="braces">(</span><span id="braces">)</span>;
    <span id="var">$self</span>-&gt;<span id="method">source</span><span id="braces">(</span><span id="braces">)</span>;</pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE4" id="CODE4"></a>clean</td><td ><a href="#POD3">description</a></td><td ><a href="#CODE3">prev</a></td><td ><a href="#CODE5">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">clean</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;

    <span id="var">$self</span>-&gt;<span id="braces">{</span>fetch<span id="braces">}</span>-&gt;<span id="method">clean</span><span id="braces">(</span><span id="braces">)</span> <span id="perlKey">if</span> <span id="var">$self</span>-&gt;<span id="braces">{</span>fetch<span id="braces">}</span>;
    <span id="perlFunc">system</span><span id="braces">(</span><span id="sqStr">'rm'</span>, <span id="sqStr">'-rf'</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span><span id="braces">)</span>;</pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE5" id="CODE5"></a>compile</td><td ><a href="#POD4">description</a></td><td ><a href="#CODE4">prev</a></td><td ><a href="#CODE6">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">compile</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;

    <span id="perlFunc">chdir</span> <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span> || croak <span id="dqStr">"Build dir not set.\n"</span>;

    <span id="comment"># -- Tweak for Maemo compatibility...</span><br />    <span id="comment">#</span><br />    <span id="var">$self</span>-&gt;<span id="method">patchDebControl</span><span id="braces">(</span><span id="braces">)</span>;
    
    <span id="comment"># First build: build binaries and get build-deps</span><br />    <span id="perlKey">my</span> <span id="var">$dpkg_depcheck</span> = <span id="sqStr">'dpkg-depcheck -m -o ../build.deps'</span>;
    <span id="var">$dpkg_depcheck</span> =<span id="sqStr">''</span> <span id="perlKey">if</span> <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>sdk<span id="braces">}</span> =~ <span id="regExp">/(bora|gregale)/</span>;
    
    <span id="perlFunc">system</span><span id="braces">(</span><span id="dqStr">"<span id="var">$dpkg_depcheck</span> <span id="var">$DPKG_BUILDPACKAGE</span> | tee ../log"</span><span id="braces">)</span>;
    
    <span id="comment"># Modify debian/control with calculated build-depends if not explicitly set</span><br />    <span id="perlKey">unless</span> <span id="braces">(</span>!<span id="var">$dpkg_depcheck</span> || <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>deb<span id="braces">}</span>-&gt;<span id="braces">{</span><span id="sqStr">'build-depends'</span><span id="braces">}</span><span id="braces">)</span> <span id="braces">{</span>
      <span id="perlKey">my</span> <span id="var">@buildDeps</span> = <span id="braces">(</span><span id="braces">)</span>;
      <span id="perlKey">if</span> <span id="braces">(</span><span id="perlFunc">open</span><span id="braces">(</span>LOG, <span id="dqStr">"&lt;../build.deps"</span><span id="braces">)</span><span id="braces">)</span> <span id="braces">{</span>
          <span id="perlKey">my</span> <span id="var">$inNeeded</span> = 0;
          <span id="perlKey">while</span> <span id="braces">(</span>&lt;LOG&gt;<span id="braces">)</span> <span id="braces">{</span>
              <span id="var">$inNeeded</span> ||= <span id="regExp">/^Packages needed:$/</span>;
              <span id="perlKey">next</span> <span id="perlKey">unless</span> <span id="var">$inNeeded</span> and <span id="regExp">m/^  ([^\s\r\n]+)$/</span>;
              <span id="perlFunc">push</span> <span id="var">@buildDeps</span>, <span id="var">$1</span>;
          <span id="braces">}</span>
          <span id="perlFunc">close</span><span id="braces">(</span>LOG<span id="braces">)</span>;
      <span id="braces">}</span>

      <span id="perlKey">if</span> <span id="braces">(</span><span id="var">@buildDeps</span><span id="braces">)</span> <span id="braces">{</span>
          <span id="perlFunc">print</span> <span id="dqStr">"Adding calculated build-deps of ["</span>.<span id="perlFunc">join</span><span id="braces">(</span><span id="sqStr">', '</span>, <span id="var">@buildDeps</span><span id="braces">)</span>.<span id="dqStr">"]\n"</span>;
          <span id="perlKey">my</span> <span id="var">$control</span> = <span id="var">$self</span>-&gt;<span id="method">readDebControl</span><span id="braces">(</span><span id="braces">)</span>;
          <span id="module"><a href="Package.html">MUD::Package</a></span>::<span id="method">setField</span><span id="braces">(</span><span id="var">$control</span>, <span id="dqStr">"Build-Depends"</span>, <span id="perlFunc">join</span><span id="braces">(</span><span id="sqStr">', '</span>, <span id="var">@buildDeps</span><span id="braces">)</span><span id="braces">)</span>;
          <span id="var">$self</span>-&gt;<span id="method">writeDebControl</span><span id="braces">(</span><span id="var">$control</span><span id="braces">)</span>;
      <span id="braces">}</span>
    <span id="braces">}</span></pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE6" id="CODE6"></a>copy</td><td ><a href="#POD5">description</a></td><td ><a href="#CODE5">prev</a></td><td ><a href="#CODE7">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">copy</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;
    <span id="perlKey">my</span> <span id="var">%debs</span> = <span id="braces">(</span><span id="braces">)</span>;

    <span id="perlKey">my</span> <span id="var">$output</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>config<span id="braces">}</span>-&gt;<span id="method">directory</span><span id="braces">(</span><span id="sqStr">'UPLOAD_DIR'</span>, 1<span id="braces">)</span>;
    <span id="perlFunc">print</span> <span id="dqStr">"+++ Calculating dependencies to copy to [<span id="var">$output</span>]\n"</span>;
    <span id="var">$self</span>-&gt;<span id="method">addDebs</span><span id="braces">(</span>\<span id="var">%debs</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span>, <span id="sqStr">'*'</span><span id="braces">)</span>;
    <span id="perlKey">foreach</span> <span id="perlKey">my</span> <span id="var">$deb</span> <span id="braces">(</span><span id="perlFunc">keys</span><span id="braces">(</span><span id="var">%debs</span><span id="braces">)</span><span id="braces">)</span> <span id="braces">{</span>
        <span id="perlFunc">system</span><span id="braces">(</span><span id="sqStr">'cp'</span>, <span id="sqStr">'-v'</span>, <span id="var">$deb</span>, <span id="dqStr">"<span id="var">$output</span>/"</span><span id="braces">)</span>;
    <span id="braces">}</span></pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE7" id="CODE7"></a>fetch</td><td ><a href="#POD6">description</a></td><td ><a href="#CODE6">prev</a></td><td ><a href="#CODE8">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">fetch</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;

    <span id="comment"># -- Instantiate the right fetcher...</span><br />    <span id="comment">#</span><br />    <span id="perlKey">my</span> <span id="var">$type</span> = <span id="sqStr">'MUD::Fetch::'</span>.<span id="perlFunc">ucfirst</span><span id="braces">(</span><span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>fetch<span id="braces">}</span>-&gt;<span id="braces">{</span>type<span id="braces">}</span><span id="braces">)</span>;
    <span id="perlFunc">print</span> <span id="dqStr">"$type\n"</span>;
    <span id="perlKey">my</span> <span id="var">$fetch</span> = <span id="perlKey">eval</span><span id="braces">(</span><span id="dqStr">"use <span id="var">$type</span>;
                      return new <span id="var">$type</span>( package =&gt;\$ self-&gt;{data},
                                        workdir =&gt;\$ self-&gt;{workdir},
                                        config =&gt;\$ self-&gt;{config} )"</span><span id="braces">)</span>;
    croak <span id="dqStr">"Unable to create fetcher [<span id="var">$type</span>]: $@"</span> <span id="perlKey">if</span> $@;
    <span id="var">$self</span>-&gt;<span id="braces">{</span>fetch<span id="braces">}</span> = <span id="var">$fetch</span>;

    <span id="comment"># -- Download and unpack it...</span><br />    <span id="comment">#</span><br />    <span id="perlFunc">print</span> <span id="dqStr">"Workdir ["</span>.<span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span>.<span id="dqStr">"]\n"</span>;
    <span id="method">mkpath</span><span id="braces">(</span><span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span>, 1<span id="braces">)</span> <span id="perlKey">unless</span> -d <span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span>;
    <span id="perlFunc">chdir</span> <span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span>;
    <span id="var">$fetch</span>-&gt;<span id="method">fetch</span><span id="braces">(</span><span id="braces">)</span>;

    <span id="comment"># Note: fetch might change directory while dealing with dependencies,</span><br />    <span id="comment"># so reset</span><br />    <span id="perlFunc">chdir</span> <span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span>;
    <span id="perlKey">my</span> <span id="var">$buildDir</span> = <span id="method">basename</span><span id="braces">(</span><span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span> || <span id="sqStr">'.'</span><span id="braces">)</span>;
    <span id="perlKey">my</span> <span id="var">$origBDir</span> = <span id="var">$buildDir</span>;
    <span id="var">$buildDir</span>    =~ <span id="regExp">s/-src\b//</span>;
    <span id="perlKey">my</span> <span id="var">$version</span>  = <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="method">version</span>;
    <span id="perlFunc">print</span> <span id="dqStr">"Version = <span id="var">$version</span>, buildDir = $buildDir\n"</span>;
    <span id="var">$version</span>   ||= <span id="var">$1</span> <span id="perlKey">if</span> <span id="var">$buildDir</span> =~ <span id="regExp">s/-(\d[\w\-\.\+\:]+\w|\d\w*)*$//</span>;
    <span id="var">$version</span>   ||= <span id="var">$1</span> <span id="perlKey">if</span> !<span id="var">$version</span> and <span id="var">$buildDir</span> =~ <span id="regExp">s/(\d+)$//</span>;
    <span id="var">$version</span>     = <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="method">version</span> || <span id="var">$version</span>;
    <span id="var">$version</span>   ||= 1;
    <span id="perlFunc">print</span> <span id="dqStr">"Version = <span id="var">$version</span>, buildDir = $buildDir\n"</span>;
    <span id="var">$buildDir</span>    = <span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span> <span id="perlKey">unless</span> <span id="var">$buildDir</span> =~ <span id="regExp">/^[a-z0-9\-\+]+$/</span>;

    <span id="perlKey">my</span> <span id="var">$versionForBuild</span> = <span id="var">$version</span>;
    <span id="var">$versionForBuild</span> =~ <span id="regExp">s/-[^-]+$//g</span>;
    <span id="var">$buildDir</span>   .= <span id="dqStr">"-<span id="var">$versionForBuild</span>"</span>;
    <span id="perlFunc">print</span> <span id="dqStr">"Build dir = $buildDir\n"</span>;
    <span id="perlFunc">rename</span> <span id="var">$origBDir</span>, <span id="var">$buildDir</span> <span id="perlKey">if</span> <span id="var">$origBDir</span> <span id="perlKey">ne</span> <span id="var">$buildDir</span>;

    <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="method">version</span><span id="braces">(</span><span id="var">$version</span><span id="braces">)</span>;
    <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span> = <span id="module">File::Spec</span>-&gt;<span id="method">rel2abs</span><span id="braces">(</span><span id="var">$buildDir</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span><span id="braces">)</span>;
    <span id="perlFunc">print</span> <span id="dqStr">"Set build dir to ["</span>.<span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span>.<span id="dqStr">"]\n"</span>;
    <span id="perlFunc">system</span><span id="braces">(</span><span id="sqStr">'ln'</span>, <span id="sqStr">'-snf'</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span>.<span id="sqStr">'/.build'</span><span id="braces">)</span>;

    <span id="perlFunc">chdir</span> <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span> || croak <span id="dqStr">"Build dir not set.\n"</span>;

    <span id="comment"># -- Generate the Debian control scripts...</span><br />    <span id="comment">#</span><br />    <span id="perlKey">unless</span> <span id="braces">(</span>-f <span id="sqStr">'debian/control'</span><span id="braces">)</span> <span id="braces">{</span>
        <span id="var">$self</span>-&gt;<span id="method">genDebControl</span><span id="braces">(</span><span id="braces">)</span>;
    <span id="braces">}</span></pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE8" id="CODE8"></a>genDebControl</td><td >description</td><td ><a href="#CODE7">prev</a></td><td ><a href="#CODE9">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">genDebControl</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;

    <span id="perlKey">my</span> <span id="var">$maintainer</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>deb<span id="braces">}</span>-&gt;<span id="braces">{</span><span id="sqStr">'maintainer'</span><span id="braces">}</span>;
    <span id="perlKey">if</span> <span id="braces">(</span>!<span id="var">$maintainer</span> and -f <span id="sqStr">'AUTHORS'</span><span id="braces">)</span> <span id="braces">{</span>
        <span id="perlFunc">open</span><span id="braces">(</span>IN, <span id="dqStr">"&lt;AUTHORS"</span><span id="braces">)</span>;
        <span id="perlKey">while</span><span id="braces">(</span>&lt;IN&gt;<span id="braces">)</span> <span id="braces">{</span>
            <span id="regExp">s/\t/        /</span>;
            <span id="perlKey">next</span> <span id="perlKey">unless</span> <span id="regExp">m/((?:[^a-z][^!-\/:-@\[-`]+ )+\s*&lt;?\s*[^\s\&lt;]+?\@[^\s&gt;]+\s*&gt;?)/</span> or
                         <span id="regExp">m/[\s&lt;:]\s*([^\s\&lt;]+?\@[^\s&gt;]+)/</span>;
            <span id="var">$maintainer</span> = <span id="var">$1</span>;
            <span id="var">$maintainer</span> =~ <span id="regExp">s/\.$//</span>;
            <span id="perlKey">last</span>;
         <span id="braces">}</span>
         <span id="perlFunc">close</span><span id="braces">(</span>IN<span id="braces">)</span>;
     <span id="braces">}</span>

    <span id="comment"># `debian/changelog' must not contain an empty address.</span><br />    <span id="var">$maintainer</span> = <span id="sqStr">'MUD Build Team &lt;mud-builder-users@garage.maemo.org&gt;'</span> <span id="perlKey">if</span> !<span id="var">$maintainer</span>;

    <span id="perlFunc">print</span> <span id="dqStr">"maintainer = [<span id="var">$maintainer</span>]\n"</span>;
    <span id="perlKey">if</span> <span id="braces">(</span><span id="var">$maintainer</span> =~ <span id="regExp">/^\s*(.*?)\s*&lt;\s*(.*@.*?)\s*&gt;/</span> <span id="braces">)</span> <span id="braces">{</span>
        <span id="var">$ENV</span><span id="braces">{</span><span id="sqStr">'DEBFULLNAME'</span><span id="braces">}</span> = <span id="var">$1</span>;
        <span id="var">$maintainer</span> = <span id="var">$2</span>;
    <span id="braces">}</span>
    <span id="var">$ENV</span><span id="braces">{</span><span id="sqStr">'DEBFULLNAME'</span><span id="braces">}</span> ||= <span id="sqStr">'Unknown'</span>;
    
    <span id="perlKey">my</span> <span id="var">$type</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span> =~ <span id="regExp">/^lib/</span> ? <span id="sqStr">'l'</span> : <span id="sqStr">'s'</span>;
    <span id="var">$type</span> = <span id="var">$1</span> <span id="perlKey">if</span> <span id="braces">(</span><span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span>-&gt;<span id="braces">{</span>result<span id="braces">}</span> || <span id="sqStr">''</span><span id="braces">)</span> =~ <span id="regExp">/^(.)/</span>;
    <span id="perlKey">my</span> <span id="var">@args</span> = <span id="braces">(</span><span id="sqStr">'dh_make'</span>, 
                           <span id="sqStr">'-e'</span>, <span id="var">$maintainer</span>, 
                           <span id="dqStr">"-<span id="var">$type</span>"</span>,
                           <span id="sqStr">'-n'</span>, <span id="sqStr">'-p'</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span><span id="braces">)</span>;
    <span id="perlKey">my</span> <span id="var">$licence</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span>-&gt;<span id="braces">{</span><span id="sqStr">'copyright'</span><span id="braces">}</span>;
    <span id="perlFunc">push</span> <span id="var">@args</span>, <span id="sqStr">'-c'</span>, <span id="var">$licence</span> <span id="perlKey">if</span> <span id="var">$licence</span>;
                           
    <span id="method">croak</span><span id="braces">(</span><span id="dqStr">"Cannot fork: $!"</span><span id="braces">)</span> <span id="perlKey">unless</span> <span id="perlFunc">defined</span><span id="braces">(</span><span id="perlKey">my</span> <span id="var">$pid</span> = <span id="perlFunc">open</span><span id="braces">(</span>EXC, <span id="dqStr">"|-"</span><span id="braces">)</span><span id="braces">)</span>;
    <span id="perlKey">exec</span><span id="braces">(</span><span id="var">@args</span><span id="braces">)</span> <span id="perlKey">unless</span> <span id="var">$pid</span>;
    <span id="perlKey">while</span><span id="braces">(</span>&lt;EXC&gt;<span id="braces">)</span> <span id="braces">{</span>
        <span id="perlFunc">print</span>;
        <span id="perlFunc">print</span> EXC <span id="dqStr">"\n"</span> <span id="perlKey">if</span> <span id="regExp">/Hit &lt;enter&gt;/</span>;
    <span id="braces">}</span>
    <span id="perlFunc">close</span><span id="braces">(</span>EXC<span id="braces">)</span>;

    <span id="comment"># Make dh_make 0.37 work like dh_make 0.38</span><br />    <span id="comment"># include 'usr/share/pkgconfig/*' in debian/lib...-dev.install</span><br />    <span id="perlKey">my</span> <span id="var">$libdevinstall</span> = <span id="dqStr">"debian/"</span>.<span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span>.<span id="dqStr">"-dev.install"</span>;
    <span id="perlKey">if</span> <span id="braces">(</span><span id="var">$type</span> == <span id="sqStr">'l'</span> and -f <span id="var">$libdevinstall</span><span id="braces">)</span> <span id="braces">{</span>
      <span id="comment"># print &quot;Checking $libdevinstall\n&quot;;</span><br />    	<span id="perlFunc">open</span><span id="braces">(</span>IN, <span id="dqStr">"&lt;<span id="var">$libdevinstall</span>"</span><span id="braces">)</span> or croak <span id="dqStr">"Unable to read <span id="var">$libdevinstall</span>: $!\n"</span>;
      <span id="perlKey">my</span> <span id="braces">(</span><span id="var">@contents</span><span id="braces">)</span> = &lt;IN&gt;;
    	<span id="perlFunc">close</span><span id="braces">(</span>IN<span id="braces">)</span>;
      <span id="perlKey">if</span> <span id="braces">(</span> <span id="perlFunc">grep</span> <span id="regExp">m#^usr/share/pkgconfig/\*$#</span>, <span id="var">@contents</span> <span id="braces">)</span> <span id="braces">{</span>
        <span id="comment"># print &quot;usr/share/pkgconfig/* already included\n&quot;;</span><br />      <span id="braces">}</span> <span id="perlKey">else</span> <span id="braces">{</span>
        <span id="perlFunc">print</span> <span id="dqStr">"Adding usr/share/pkgconfig/* to $libdevinstall\n"</span>;
        <span id="perlFunc">open</span><span id="braces">(</span>OUT, <span id="dqStr">"&gt;&gt;<span id="var">$libdevinstall</span>"</span><span id="braces">)</span> or croak <span id="dqStr">"Unable to append to <span id="var">$libdevinstall</span>: $!\n"</span>;
        <span id="perlFunc">print</span> OUT <span id="dqStr">"usr/share/pkgconfig/*\n"</span>;
        <span id="perlFunc">close</span> OUT;
      <span id="braces">}</span>
    <span id="braces">}</span>

    <span id="comment"># Make dh_make 0.38 and earlier work like dh_make 0.42</span><br />    <span id="comment"># MAKE install var=xx =&gt; MAKE var=xx install</span><br />    <span id="perlFunc">system</span><span id="braces">(</span><span id="sqStr">'sed'</span>,<span id="sqStr">'-i'</span>,<span id="sqStr">'debian/rules'</span>,<span id="sqStr">'-e'</span>,<span id="sqStr">'/$(MAKE) install ./s/\(install\)\( .*\)/\2\1 /'</span><span id="braces">)</span>;

    <span id="perlKey">foreach</span> <span id="perlKey">my</span> <span id="var">$f</span> <span id="braces">(</span>&lt;debian<span id="regExp">/*.files&gt;) {<br />        my </span><span id="var">$i</span><span id="regExp"> = </span><span id="var">$f</span>;<br />        <span id="var">$i</span> =~ <span id="regExp">s/\.files$/\.install/</span>;
        <span id="perlFunc">rename</span> <span id="var">$f</span>, <span id="var">$i</span>;</pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE9" id="CODE9"></a>new</td><td ><a href="#POD7">description</a></td><td ><a href="#CODE8">prev</a></td><td ><a href="#CODE10">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">new</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$that</span> = <span id="perlFunc">shift</span>;
    <span id="var">$that</span> = <span id="perlFunc">ref</span><span id="braces">(</span><span id="var">$that</span><span id="braces">)</span> || <span id="var">$that</span>;

    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">bless</span> <span id="braces">{</span> <span id="var">@_</span> <span id="braces">}</span>, <span id="var">$that</span>;
    <span id="var">$self</span>-&gt;<span id="method">_init</span><span id="braces">(</span><span id="braces">)</span>;
    <span id="perlKey">return</span> <span id="var">$self</span>;</pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE10" id="CODE10"></a>patch</td><td ><a href="#POD8">description</a></td><td ><a href="#CODE9">prev</a></td><td ><a href="#CODE11">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">patch</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;

    <span id="perlFunc">chdir</span> <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span> || croak <span id="dqStr">"Build dir not set.\n"</span>;

    <span id="comment"># -- Apply any patches...</span><br />    <span id="comment"># </span><br />    <span id="perlKey">my</span> <span id="var">$patch</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>config<span id="braces">}</span>-&gt;<span id="method">directory</span><span id="braces">(</span><span id="sqStr">'PACKAGES_DIR'</span><span id="braces">)</span>.<span id="sqStr">'/patch/'</span>.<span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span>.<span id="sqStr">'.patch'</span>;
    <span id="perlFunc">print</span> <span id="dqStr">"+++ Checking patch file [<span id="var">$patch</span>]\n"</span>;
    <span id="perlKey">if</span> <span id="braces">(</span>-f <span id="var">$patch</span><span id="braces">)</span> <span id="braces">{</span>
        <span id="perlFunc">system</span><span id="braces">(</span><span id="dqStr">"patch -p0 &lt;<span id="var">$patch</span>"</span><span id="braces">)</span>;
        croak <span id="dqStr">"Failed to apply patch [$?]\n"</span> <span id="perlKey">if</span> $?;
    <span id="braces">}</span>

    <span id="comment"># -- Remove documentation...</span><br />    <span id="comment">#</span><br />    <span id="perlKey">my</span> <span id="var">$include</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span>-&gt;<span id="braces">{</span>include<span id="braces">}</span> || <span id="sqStr">''</span>;
    <span id="var">$include</span> =~ <span id="regExp">s/\W+/|/g</span>;
    <span id="var">$include</span> = <span id="dqStr">"|<span id="var">$include</span>|"</span>;

    <span id="perlKey">my</span> <span id="var">@replace</span> = <span id="perlFunc">grep</span> <span id="braces">{</span> <span id="var">$include</span> !~ <span id="regExp">/\|$_\|/</span> <span id="braces">}</span> <span id="var">@PREVENT_INSTALL</span>;
    <span id="perlKey">my</span> <span id="var">$rules</span> = <span id="sqStr">''</span>;
    <span id="perlFunc">open</span><span id="braces">(</span>IN, <span id="dqStr">"&lt;debian/rules"</span><span id="braces">)</span> or croak <span id="dqStr">"Unable to open debian/rules: $!\n"</span>;
    <span id="perlKey">while</span><span id="braces">(</span>&lt;IN&gt;<span id="braces">)</span> <span id="braces">{</span> <span id="var">$rules</span> .= <span id="var">$_</span>; <span id="braces">}</span>
    <span id="perlFunc">close</span><span id="braces">(</span>IN<span id="braces">)</span>;
    <span id="perlKey">my</span> <span id="var">$origRules</span> = <span id="var">$rules</span>;

    <span id="perlFunc">print</span> <span id="dqStr">"+++ Preventing install of ["</span>.<span id="perlFunc">join</span><span id="braces">(</span><span id="sqStr">','</span>, <span id="var">@replace</span><span id="braces">)</span>.<span id="dqStr">"] in deb.\n"</span>;
    <span id="var">$rules</span> =~ <span id="regExp">s/^(\s+dh_install$_\b.*)$/#$1/mg</span> <span id="perlKey">foreach</span> <span id="var">@replace</span>;

    <span id="comment"># -- Include dh_install...</span><br />    <span id="comment">#</span><br />    <span id="var">$rules</span> =~ <span id="regExp">s/^\s*#\s*dh_install\s*$/\tdh_install --sourcedir=debian\/tmp/mg</span>;

    <span id="comment"># -- Append configure flags...</span><br />    <span id="comment">#</span><br />    <span id="perlKey">my</span> <span id="var">$append</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span>-&gt;<span id="braces">{</span><span id="sqStr">'configure-append'</span><span id="braces">}</span> || <span id="sqStr">''</span>;
    <span id="perlFunc">print</span> <span id="dqStr">"+++ Appending [<span id="var">$append</span>] to configure.\n"</span>;
    <span id="var">$rules</span> =~ <span id="regExp">s/([\b\s]\.\/configure[\b\s].*?)([\r\n]+?\s*[\r\n]+?)/</span><span id="var">$1</span><span id="regExp"> </span><span id="var">$append</span><span id="var">$2</span><span id="regExp">/sg</span> <span id="perlKey">if</span> <span id="var">$append</span>;

    <span id="comment"># -- Write back debian/rules...</span><br />    <span id="comment">#</span><br />    <span id="perlKey">if</span> <span id="braces">(</span><span id="var">$origRules</span> <span id="perlKey">ne</span> <span id="var">$rules</span><span id="braces">)</span> <span id="braces">{</span>
        <span id="perlFunc">open</span><span id="braces">(</span>OUT, <span id="dqStr">"&gt;debian/rules"</span><span id="braces">)</span> or croak <span id="dqStr">"Can't write debian/rules: $!\n"</span>;
        <span id="perlFunc">print</span> OUT <span id="var">$rules</span>;
        <span id="perlFunc">close</span><span id="braces">(</span>OUT<span id="braces">)</span>;
    <span id="braces">}</span></pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE11" id="CODE11"></a>patchDebControl</td><td >description</td><td ><a href="#CODE10">prev</a></td><td ><a href="#CODE12">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">patchDebControl</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;

    <span id="perlKey">my</span> <span id="var">$control</span> = <span id="var">$self</span>-&gt;<span id="method">readDebControl</span><span id="braces">(</span><span id="braces">)</span>;
    <span id="perlKey">my</span> <span id="var">$origControl</span> = <span id="var">$control</span>;

    <span id="comment"># -- Fix standards version and uploaders...</span><br />    <span id="comment">#</span><br />    <span id="var">$control</span> =~ <span id="regExp">s/^(Section:.*)devel/</span><span id="var">$1libdev</span><span id="regExp">/</span>;
    <span id="module"><a href="Package.html">MUD::Package</a></span>::<span id="method">setField</span><span id="braces">(</span><span id="var">$control</span>, <span id="sqStr">'Standards-Version'</span>, <span id="sqStr">'3.6.1'</span><span id="braces">)</span>;
    <span id="module"><a href="Package.html">MUD::Package</a></span>::<span id="method">setField</span><span id="braces">(</span><span id="var">$control</span>, <span id="sqStr">'Uploaders'</span>, <span id="sqStr">'MUD Project &lt;mud-builder-team@garage.maemo.org&gt;'</span><span id="braces">)</span>;

    <span id="comment"># -- Fix &quot;BROKEN&quot; libraries...</span><br />    <span id="comment">#</span><br />    <span id="perlKey">my</span> <span id="var">$name</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span>;
    <span id="perlKey">my</span> <span id="var">$libname</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>deb<span id="braces">}</span>-&gt;<span id="braces">{</span><span id="sqStr">'library'</span><span id="braces">}</span> || <span id="dqStr">"${name}1"</span>;
    <span id="var">$control</span> =~ <span id="regExp">s/\Q${name}\EBROKEN/${libname}/mgi</span>;

    <span id="comment"># -- Fix lib-dev package name</span><br />    <span id="comment">#</span><br />    <span id="perlKey">my</span> <span id="var">$libdevname</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>deb<span id="braces">}</span>-&gt;<span id="braces">{</span><span id="sqStr">'libdev'</span><span id="braces">}</span> || <span id="dqStr">"${name}-dev"</span>;
    <span id="var">$control</span> =~ <span id="regExp">s/\Q${name}\E-dev/${libdevname}/mgi</span>;

    <span id="comment"># -- Fix section...</span><br />    <span id="comment"># TODO Use $self-&gt;{data}-&gt;section</span><br />    <span id="perlKey">my</span> <span id="var">$userSection</span> = <span id="perlFunc">defined</span> <span id="braces">(</span><span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>deb<span id="braces">}</span>-&gt;<span id="braces">{</span><span id="sqStr">'prefix-section'</span><span id="braces">}</span><span id="braces">)</span> 
        ? <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>deb<span id="braces">}</span>-&gt;<span id="braces">{</span><span id="sqStr">'prefix-section'</span><span id="braces">}</span> : <span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span> !~ <span id="regExp">/^lib/</span>;
        
    <span id="var">$control</span> =~ <span id="regExp">s/^(Section:)\s*(user\/)*(.*)$/$1 user\/$3/mig</span> <span id="perlKey">if</span> <span id="var">$userSection</span>;

    <span id="comment"># -- Fix dependencies...</span><br />    <span id="comment">#</span><br />    <span id="var">$control</span> =~ <span id="regExp">s/\${perl:Depends}//g</span>;

    <span id="comment"># -- Icon(s)...</span><br />    <span id="comment">#</span><br />    <span id="perlKey">my</span> <span id="var">$iconFile</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>deb<span id="braces">}</span>-&gt;<span id="braces">{</span>icon<span id="braces">}</span>;
    <span id="perlKey">if</span> <span id="braces">(</span>! -f <span id="var">$iconFile</span><span id="braces">)</span> <span id="braces">{</span>
      <span id="perlKey">foreach</span> <span id="perlKey">my</span> <span id="var">$suffix</span> <span id="braces">(</span><span id="braces">(</span><span id="sqStr">'-26.png'</span>, <span id="sqStr">'-32.png'</span>, <span id="sqStr">'-40.png'</span>, <span id="sqStr">'-48.png'</span>, <span id="sqStr">'-64.png'</span>, <span id="sqStr">''</span><span id="braces">)</span><span id="braces">)</span> <span id="braces">{</span>
        <span id="var">$iconFile</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>config<span id="braces">}</span>-&gt;<span id="method">directory</span><span id="braces">(</span><span id="sqStr">'PACKAGES_DIR'</span><span id="braces">)</span>.<span id="sqStr">'/icon/'</span>.<span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span>.<span id="var">$suffix</span>;
        <span id="perlKey">last</span> <span id="perlKey">if</span> -f <span id="var">$iconFile</span>;
      <span id="braces">}</span>
    <span id="braces">}</span>

    <span id="perlKey">if</span> <span id="braces">(</span>! -f <span id="var">$iconFile</span> and <span id="braces">(</span><span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>deb<span id="braces">}</span>-&gt;<span id="braces">{</span>icon<span id="braces">}</span> || <span id="sqStr">''</span><span id="braces">)</span> =~ <span id="regExp">/^https?:.*?\.(\w+)(\?.*)?$/</span><span id="braces">)</span> <span id="braces">{</span>
        <span id="var">$iconFile</span> = <span id="var">$self</span>-&gt;<span id="braces">{</span>workdir<span id="braces">}</span>.<span id="sqStr">'/'</span>.<span id="var">$self</span>-&gt;<span id="braces">{</span><span id="perlKey">package</span><span id="braces">}</span>.<span id="dqStr">".<span id="var">$1</span>"</span>;
        <span id="perlFunc">system</span><span id="braces">(</span><span id="sqStr">'wget'</span>, <span id="sqStr">'-O'</span>, <span id="var">$iconFile</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>deb<span id="braces">}</span>-&gt;<span id="braces">{</span>icon<span id="braces">}</span><span id="braces">)</span>;
    <span id="braces">}</span>

    <span id="perlKey">if</span> <span id="braces">(</span>-f <span id="var">$iconFile</span> and <span id="var">$control</span> !~ <span id="regExp">/^XB-Maemo-Icon-26:/im</span><span id="braces">)</span> <span id="braces">{</span>
        <span id="perlFunc">system</span><span id="braces">(</span><span id="sqStr">'convert'</span>, <span id="var">$iconFile</span>, <span id="sqStr">'-resize'</span>, <span id="sqStr">'26x26'</span>, <span id="var">$iconFile</span><span id="braces">)</span>;
        <span id="perlKey">my</span> <span id="var">$iconData</span> = `uuencode -m icon &lt;<span id="var">$iconFile</span>`;
        <span id="var">$iconData</span> =~ <span id="regExp">s/^begin-base64 \d{3,4} icon[\s\r\n]+//m</span>;
        <span id="var">$iconData</span> =~ <span id="regExp">s/^/  /mg</span>;
        <span id="perlKey">if</span> <span id="braces">(</span><span id="var">$iconData</span><span id="braces">)</span> <span id="braces">{</span>
            <span id="perlFunc">chomp</span><span id="braces">(</span><span id="var">$iconData</span><span id="braces">)</span>;
            <span id="var">$control</span> =~ <span id="regExp">s/^Package: .*$/$&amp;\nXB-Maemo-Icon-26:$iconData/mg</span>;
        <span id="braces">}</span>
    <span id="braces">}</span>

    <span id="comment"># -- Description...</span><br />    <span id="comment">#</span><br />    <span id="module"><a href="Package.html">MUD::Package</a></span>::<span id="method">setField</span><span id="braces">(</span><span id="var">$control</span>, <span id="dqStr">"Description"</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="method">description</span><span id="braces">)</span>;

    <span id="comment"># -- Upgrade Description...</span><br />    <span id="comment">#</span><br />    <span id="module"><a href="Package.html">MUD::Package</a></span>::<span id="method">setField</span><span id="braces">(</span><span id="var">$control</span>, <span id="dqStr">"XB-Maemo-Upgrade-Description"</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="method">upgradeDescription</span><span id="braces">)</span>;

    <span id="comment"># -- Display Name...</span><br />    <span id="comment">#</span><br />    <span id="module"><a href="Package.html">MUD::Package</a></span>::<span id="method">setField</span><span id="braces">(</span><span id="var">$control</span>, <span id="dqStr">"XB-Maemo-Display-Name"</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="method">displayName</span><span id="braces">)</span>;

    <span id="comment"># -- Other control fields...</span><br />    <span id="comment">#</span><br />    <span id="perlKey">while</span> <span id="braces">(</span><span id="perlKey">my</span> <span id="braces">(</span><span id="var">$k</span>, <span id="var">$v</span><span id="braces">)</span> = <span id="perlFunc">each</span> %<span id="braces">{</span> <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="method">controlFields</span> <span id="braces">}</span><span id="braces">)</span> <span id="braces">{</span>
        <span id="module"><a href="Package.html">MUD::Package</a></span>::<span id="method">setField</span><span id="braces">(</span><span id="var">$control</span>, <span id="var">$k</span>, <span id="var">$v</span><span id="braces">)</span>;
    <span id="braces">}</span>

    <span id="var">$self</span>-&gt;<span id="method">writeDebControl</span><span id="braces">(</span><span id="var">$control</span><span id="braces">)</span> <span id="perlKey">if</span> <span id="var">$control</span> <span id="perlKey">ne</span> <span id="var">$origControl</span>;
    
    <span id="comment"># -- Modify changelog to contain this build...</span><br />    <span id="comment">#</span><br />    <span id="comment"># debchange doesn't do anything if the version is already there except moan</span><br />    <span id="perlFunc">system</span><span id="braces">(</span><span id="sqStr">'debchange'</span>, <span id="sqStr">'-v'</span>, <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="method">version</span>,
                        <span id="sqStr">'-p'</span>, <span id="sqStr">'--noquery'</span>,
                        <span id="sqStr">'Build using mud-builder by '</span>.<span id="braces">(</span><span id="var">$ENV</span><span id="braces">{</span>USER<span id="braces">}</span> || <span id="sqStr">'unknown'</span><span id="braces">)</span><span id="braces">)</span>;

    <span id="comment"># -- Patch other miscellaneous problems...</span><br />    <span id="comment">#</span><br />    <span id="perlFunc">system</span><span id="braces">(</span><span id="sqStr">'echo 4 &gt;debian/compat'</span><span id="braces">)</span>;</pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE12" id="CODE12"></a>readDebControl</td><td >description</td><td ><a href="#CODE11">prev</a></td><td ><a href="#CODE13">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">readDebControl</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;
    <span id="perlKey">my</span> <span id="var">$control</span> = <span id="sqStr">''</span>;
    <span id="perlFunc">open</span><span id="braces">(</span>IN, <span id="dqStr">"&lt;debian/control"</span><span id="braces">)</span> or croak <span id="dqStr">"Unable to read control: $!\n"</span>;
    <span id="perlKey">while</span><span id="braces">(</span>&lt;IN&gt;<span id="braces">)</span> <span id="braces">{</span> <span id="var">$control</span> .= <span id="var">$_</span>; <span id="braces">}</span>
    <span id="perlFunc">close</span><span id="braces">(</span>IN<span id="braces">)</span>;
    
    <span id="perlKey">return</span> <span id="var">$control</span>;</pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE13" id="CODE13"></a>source</td><td ><a href="#POD9">description</a></td><td ><a href="#CODE12">prev</a></td><td ><a href="#CODE14">next</a></td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">source</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;

    <span id="perlFunc">chdir</span> <span id="var">$self</span>-&gt;<span id="braces">{</span>data<span id="braces">}</span>-&gt;<span id="braces">{</span>build<span id="braces">}</span> || croak <span id="dqStr">"Build dir not set.\n"</span>;

    <span id="comment"># Now build source package for upload</span><br />    <span id="perlFunc">system</span><span id="braces">(</span><span id="dqStr">"<span id="var">$DPKG_BUILDPACKAGE</span> -S | tee -a ../log"</span><span id="braces">)</span>;</pre>}</td></div>
<div id="sep"></div>
<table id="methCodeTitle" width="100%"><tr><td width="200"><a name="CODE14" id="CODE14"></a>writeDebControl</td><td >description</td><td ><a href="#CODE13">prev</a></td><td >next</td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="methCodeArea"><td ><span id="sub">sub</span> <span id="subName">writeDebControl</span>
{<pre>    <span id="perlKey">my</span> <span id="var">$self</span> = <span id="perlFunc">shift</span>;
    <span id="perlKey">my</span> <span id="braces">(</span><span id="var">$control</span><span id="braces">)</span> = <span id="var">@_</span>;
      
    <span id="perlFunc">print</span> <span id="var">$control</span>;
    <span id="perlFunc">rename</span> <span id="dqStr">"debian/control"</span>, <span id="dqStr">"debian/control.mud"</span>;
    <span id="perlFunc">open</span><span id="braces">(</span>OUT, <span id="dqStr">"&gt;debian/control"</span><span id="braces">)</span> or croak <span id="dqStr">"Unable to write control: $!\n"</span>;
    <span id="perlFunc">print</span> OUT <span id="var">$control</span>;
    <span id="perlFunc">close</span><span id="braces">(</span>OUT<span id="braces">)</span> or croak <span id="dqStr">"Unable to close control: $!\n"</span>;</pre>}</td></div>
<div id="sep"></div>
<a name="General" id="General"></a>
<div id="mainTitle">General documentation</div>
<div id="sep"></div>
<table id="genInfoTitle" width="100%"><tr><td><a name="_pod_COPYRIGHT" id="_pod_COPYRIGHT"></a>COPYRIGHT</td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="genInfoArea">(c) Andrew Flegg 2007 - 2009. Released under the Artistic Licence:<br /><a href="#_pod_http://www.opensource.org/licenses/artistic-license-2.0.php">http://www.opensource.org/licenses/artistic-license-2.0.php</a></div>
<div id="sep"></div>
<table id="genInfoTitle" width="100%"><tr><td><a name="_pod_SEE ALSO" id="_pod_SEE ALSO"></a>SEE ALSO</td><td align="right"><a href="#TOP">Top</a></td></tr></table>
<div id="genInfoArea"><a href="#_pod_http://mud-builder.garage.maemo.org/">http://mud-builder.garage.maemo.org/</a></div>
<div id="sep"></div>
</body>
</html>
